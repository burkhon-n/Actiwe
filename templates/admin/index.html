<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            DEFAULT: '#1e40af',
                            light: '#3b82f6',
                            dark: '#1e3a8a',
                        },
                        accent: {
                            DEFAULT: '#0f172a',
                            light: '#334155',
                            dark: '#0c1425',
                        }
                    },
                }
            }
        }
    </script>
    <style>
        .product-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
        }
        .loader {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: #1e40af;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .glass-effect {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
   <nav class="fixed top-0 left-0 w-full glass-effect shadow-lg flex flex-wrap items-center justify-between px-6 py-4 z-20">
       <div class="flex-1 hidden sm:block"></div>
       <a href="/" class="flex-1 flex justify-center">
           <img src="{{ logo }}" alt="Shop Logo" class="h-8 md:h-10">
       </a>
       <div class="flex-1 flex justify-end">
           <button id="add-item-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold shadow hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2 w-full sm:w-auto">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            <span>Add item</span>
        </button>
    </div>
</nav>
    
    <div class="container mx-auto p-6 pt-20">
        <!-- Loading state -->
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <p class="text-lg text-gray-600">Loading items...</p>
        </div>

        <!-- Error state -->
        <div id="error" class="hidden text-center py-20">
            <p class="text-red-500 font-semibold text-lg">An error occurred while loading.</p>
        </div>

        <!-- Item cards container -->
        <div id="items-container" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Item cards will be injected here by JavaScript -->
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 hidden flex items-center justify-center z-50 modal-backdrop">
        <div class="bg-white rounded-xl p-6 shadow-xl max-w-sm w-full text-center">
            <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.344 18c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Are you sure?</h3>
            <p class="text-gray-600 mb-4">Do you really want to delete this item? This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-delete-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors">Yes, delete it</button>
                <button id="cancel-delete-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition-colors">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            const itemsContainer = document.getElementById('items-container');
            const deleteModal = document.getElementById('delete-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const addItemBtn = document.getElementById('add-item-btn');

            let currentItemId = null;
            let initData = null;
            let initDataUnsafe = null;

            const showLoading = () => {
                loadingElement.classList.remove('hidden');
                errorElement.classList.add('hidden');
                itemsContainer.classList.add('hidden');
            };

            const showError = (message) => {
                loadingElement.classList.add('hidden');
                errorElement.classList.remove('hidden');
                itemsContainer.classList.add('hidden');
                errorElement.innerHTML = `<p class="text-red-500 font-semibold text-lg">${message}</p>`;
            };

            const fetchItems = async () => {
                try {
                    const response = await fetch("/api/admin/items", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ initData, initDataUnsafe })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to fetch items.');
                    }

                    const items = await response.json();
                    renderItems(items);
                    loadingElement.classList.add('hidden');
                    itemsContainer.classList.remove('hidden');

                } catch (err) {
                    console.error('Error fetching items:', err);
                    showError(err.message || 'An unexpected error occurred.');
                }
            };

            const renderItems = (items) => {
                itemsContainer.innerHTML = '';
                if (items.length === 0) {
                    itemsContainer.innerHTML = `<p class="text-gray-500 text-center py-10 col-span-full">No items found.</p>`;
                    return;
                }
                items.forEach(item => {
                    const card = document.createElement('div');
                    // Leave space after every 3rd digit starting from the right
                    let formattedPrice = item.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                    card.className = 'product-card rounded-xl shadow-lg overflow-hidden';
                    card.innerHTML = `
                        <img src="${item.image}" alt="${item.title}" class="w-full h-48 object-cover">
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold text-gray-800">${item.title}</h3>
                                <p class="text-blue-700 font-bold text-lg">${formattedPrice} UZS</p>
                            </div>
                            <div class="flex justify-center gap-4 mt-4">
                                <button onclick="redirectToEdit(${item.id})" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors w-full">Edit</button>
                                <button onclick="showDeleteModal(${item.id})" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors w-full">Delete</button>
                            </div>
                        </div>
                    `;
                    itemsContainer.appendChild(card);
                });
            };

            // Global functions for buttons
            window.showDeleteModal = (itemId) => {
                currentItemId = itemId;
                deleteModal.classList.remove('hidden');
            };

            window.redirectToEdit = (itemId) => {
                const url = `/admin/items/edit/${itemId}?initData=${encodeURIComponent(initData)}&initDataUnsafe=${encodeURIComponent(JSON.stringify(initDataUnsafe))}`;
                window.location.href = url;
            };

            const deleteItem = async () => {
                if (currentItemId === null) return;
                
                try {
                    const response = await fetch(`/api/admin/items/${currentItemId}`, {
                        method: 'DELETE',
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ initData, initDataUnsafe })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to delete item.');
                    }

                    const cardToRemove = document.querySelector(`[onclick="showDeleteModal(${currentItemId})"]`).closest('.product-card');
                    if (cardToRemove) {
                        cardToRemove.remove();
                    }
                } catch (err) {
                    console.error('Error deleting item:', err);
                } finally {
                    deleteModal.classList.add('hidden');
                    currentItemId = null;
                }
            };

            const redirectToAdd = () => {
                const url = `/admin/items/add?initData=${encodeURIComponent(initData)}&initDataUnsafe=${encodeURIComponent(JSON.stringify(initDataUnsafe))}`;
                window.location.href = url;
            }
            
            // Event listeners for modal buttons
            confirmDeleteBtn.addEventListener('click', deleteItem);
            cancelDeleteBtn.addEventListener('click', () => {
                deleteModal.classList.add('hidden');
                currentItemId = null;
            });
            addItemBtn.addEventListener('click', redirectToAdd);

            // Main function to check auth and load content
            const checkAuthAndLoad = async () => {
                showLoading();
                try {
                    if (!window.Telegram || !window.Telegram.WebApp) {
                        throw new Error("Telegram WebApp not found.");
                    }
                    window.Telegram.WebApp.ready();
                    initData = window.Telegram.WebApp.initData;
                    initDataUnsafe = window.Telegram.WebApp.initDataUnsafe;

                    const response = await fetch("/auth/check_role", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ initData, initDataUnsafe })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && (data.role === 'admin' || data.role === 'sadmin')) {
                        await fetchItems();
                    } else {
                        showError("You do not have permission to access this page.");
                    }
                } catch (e) {
                    console.error("Authentication error:", e);
                    showError("Authentication failed. Please open from the Telegram app.");
                }
            };
            
            checkAuthAndLoad();
        });
    </script>
</body>
</html>
